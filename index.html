<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>è‚¡å¸‚å¤§å¸« Pro</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;è‚¡å¸‚å¤§å¸« Pro&quot;,&quot;short_name&quot;:&quot;è‚¡å¸‚å¤§å¸«&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%231a1a2e&quot;,&quot;theme_color&quot;:&quot;%231a1a2e&quot;}">
    
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-light: #a29bfe;
            --secondary: #00cec9;
            --accent: #fd79a8;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --rise: #e74c3c;
            --fall: #27ae60;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #0f3460;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border: #2d3a5a;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: calc(var(--safe-top) + 60px);
            padding-bottom: calc(var(--safe-bottom) + 70px);
        }

        /* ===== ä»¿ iPhone ç‹€æ…‹åˆ— ===== */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(var(--safe-top) + 44px);
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f3460 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .status-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            padding: 0 20px;
        }

        .status-time {
            font-size: 14px;
            font-weight: 600;
        }

        .status-title {
            font-size: 17px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-icons {
            display: flex;
            gap: 5px;
            font-size: 12px;
        }

        /* ===== åº•éƒ¨å°èˆª ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--safe-bottom) + 65px);
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 12px;
            min-width: 60px;
        }

        .nav-item.active {
            background: rgba(108, 92, 231, 0.2);
        }

        .nav-item.active .nav-icon {
            color: var(--primary);
            transform: scale(1.1);
        }

        .nav-item.active .nav-label {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 24px;
            transition: all 0.3s;
        }

        .nav-label {
            font-size: 10px;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        /* ===== ä¸»å…§å®¹å€ ===== */
        .main-content {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== å¡ç‰‡æ¨£å¼ ===== */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .card-icon.purple { background: linear-gradient(135deg, #6c5ce7, #a29bfe); }
        .card-icon.blue { background: linear-gradient(135deg, #0984e3, #74b9ff); }
        .card-icon.green { background: linear-gradient(135deg, #00b894, #55efc4); }
        .card-icon.orange { background: linear-gradient(135deg, #e17055, #fab1a0); }
        .card-icon.pink { background: linear-gradient(135deg, #fd79a8, #f8a5c2); }
        .card-icon.gold { background: linear-gradient(135deg, #f39c12, #f1c40f); }
        .card-icon.red { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .card-icon.teal { background: linear-gradient(135deg, #00cec9, #81ecec); }

        /* ===== è¡¨å–®å…ƒç´  ===== */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* ===== æŒ‰éˆ• ===== */
        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #55efc4);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e74c3c);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #e17055, #fdcb6e);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 13px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* ===== è‡ªé¸è‚¡åˆ—è¡¨ ===== */
        .watchlist {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .watchlist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .watchlist-item:active {
            background: var(--primary);
        }

        .watchlist-item .stock-info {
            display: flex;
            flex-direction: column;
        }

        .watchlist-item .stock-name {
            font-weight: 600;
            font-size: 15px;
        }

        .watchlist-item .stock-code {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .watchlist-item .remove-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(214, 48, 49, 0.2);
            color: var(--danger);
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== è‚¡åƒ¹é¡¯ç¤º ===== */
        .stock-price-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-input), var(--bg-card));
            border-radius: 16px;
            margin-bottom: 15px;
        }

        .stock-price-display .name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stock-price-display .code {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stock-price-display .price {
            font-size: 36px;
            font-weight: 700;
        }

        .stock-price-display .change {
            font-size: 16px;
            margin-top: 5px;
        }

        .text-rise { color: var(--rise); }
        .text-fall { color: var(--fall); }

        /* ===== æ¨™ç±¤é  ===== */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 8px 14px;
            border-radius: 20px;
            border: none;
            background: var(--bg-input);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* ===== åœ–è¡¨å®¹å™¨ ===== */
        .chart-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            min-height: 300px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* ===== é€±æœŸé¸æ“‡å™¨ ===== */
        .period-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .period-btn {
            padding: 6px 12px;
            border-radius: 15px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ===== è³‡æ–™è¡¨æ ¼ ===== */
        .data-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 10px 8px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .data-table th {
            background: var(--bg-input);
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }

        .data-table th:first-child,
        .data-table td:first-child {
            text-align: left;
        }

        .data-table tbody tr:active {
            background: rgba(108, 92, 231, 0.1);
        }

        /* ===== AI çµæœ ===== */
        .ai-result {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 15px;
            font-size: 14px;
            line-height: 1.7;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        /* ===== è¼‰å…¥å‹•ç•« ===== */
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .loader.show {
            display: block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== ç‹€æ…‹è¨Šæ¯ ===== */
        .status-msg {
            font-size: 13px;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .status-msg.success {
            background: rgba(0, 184, 148, 0.1);
            color: var(--success);
        }

        .status-msg.error {
            background: rgba(214, 48, 49, 0.1);
            color: var(--danger);
        }

        .status-msg.info {
            background: rgba(108, 92, 231, 0.1);
            color: var(--primary-light);
        }

        /* ===== å›æ¸¬çµæœ ===== */
        .backtest-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .summary-card {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .summary-card .label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 18px;
            font-weight: 700;
        }

        /* ===== åˆ†é æŒ‡ç¤ºå™¨ ===== */
        .sub-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 10px;
        }

        .sub-tab {
            padding: 10px 16px;
            background: var(--bg-input);
            border-radius: 10px;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .sub-tab.active {
            background: var(--primary);
            color: white;
        }

        /* ===== æª”æ¡ˆä¸Šå‚³ ===== */
        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload:active {
            border-color: var(--primary);
            background: rgba(108, 92, 231, 0.1);
        }

        .file-upload input {
            display: none;
        }

        .file-upload .icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        /* ===== ç©ºç‹€æ…‹ ===== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* ===== Toast é€šçŸ¥ ===== */
        .toast {
            position: fixed;
            top: calc(var(--safe-top) + 60px);
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(10px);
        }

        /* ===== æ¨¡æ…‹æ¡† ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-input);
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
        }

        .modal-body {
            padding: 16px;
        }

        /* ===== å¼•ç”¨ä¾†æº ===== */
        .citations {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .citations h4 {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .citations a {
            display: block;
            color: var(--primary-light);
            font-size: 13px;
            margin-bottom: 5px;
            text-decoration: none;
        }

        /* ===== éŸ¿æ‡‰å¼èª¿æ•´ ===== */
        @media (min-width: 768px) {
            .main-content {
                max-width: 600px;
            }

            .backtest-summary {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- ç‹€æ…‹åˆ— -->
    <div class="status-bar">
        <div class="status-bar-content">
            <span class="status-time" id="statusTime">09:00</span>
            <span class="status-title">ğŸ“ˆ è‚¡å¸‚å¤§å¸« Pro</span>
            <span class="status-icons">ğŸ“¶ ğŸ”‹</span>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-content">
        <!-- ========== é¦–é  ========== -->
        <div class="page active" id="page-home">
            <!-- è‚¡åƒ¹é¡¯ç¤º -->
            <div class="stock-price-display" id="stockPriceDisplay">
                <div class="name" id="displayStockName">å°šæœªè¼‰å…¥è‚¡ç¥¨</div>
                <div class="code" id="displayStockCode">è«‹å…ˆæŸ¥è©¢æˆ–é¸æ“‡è‚¡ç¥¨</div>
                <div class="price" id="displayPrice">--</div>
                <div class="change" id="displayChange">--</div>
            </div>

            <!-- å¿«é€ŸæŸ¥è©¢ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon blue">ğŸ”</div>
                        å¿«é€ŸæŸ¥è©¢
                    </div>
                </div>
                <div class="form-group">
                    <input type="text" id="stockCodeInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ (å¦‚: 2330)">
                </div>
                <div class="btn-group">
                    <input type="date" id="startDateInput" style="flex: 1;">
                    <input type="date" id="endDateInput" style="flex: 1;">
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 10px;" id="fetchDataBtn">
                    ğŸš€ é–‹å§‹æŸ¥è©¢
                </button>
                <div class="loader" id="homeLoader"></div>
                <div id="queryStatus"></div>
            </div>

            <!-- æˆ‘çš„è‡ªé¸è‚¡ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon gold">â­</div>
                        æˆ‘çš„è‡ªé¸è‚¡
                    </div>
                    <button class="btn btn-sm btn-secondary" id="addWatchlistBtn">+ æ–°å¢</button>
                </div>
                <div class="watchlist" id="watchlistContainer">
                    <div class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <p>å°šç„¡è‡ªé¸è‚¡</p>
                    </div>
                </div>
            </div>

            <!-- CSV ä¸Šå‚³ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon green">ğŸ“</div>
                        åŒ¯å…¥ CSV
                    </div>
                </div>
                <label class="file-upload">
                    <input type="file" id="csvFileInput" accept=".csv">
                    <div class="icon">ğŸ“„</div>
                    <p>é»æ“Šä¸Šå‚³ CSV æª”æ¡ˆ</p>
                </label>
            </div>
        </div>

        <!-- ========== åœ–è¡¨é  ========== -->
        <div class="page" id="page-chart">
            <!-- é€±æœŸé¸æ“‡ -->
            <div class="period-selector">
                <button class="period-btn active" data-period="day">æ—¥</button>
                <button class="period-btn" data-period="week">é€±</button>
                <button class="period-btn" data-period="month">æœˆ</button>
            </div>

            <!-- åœ–è¡¨æ¨™ç±¤ -->
            <div class="tabs" id="chartTabs">
                <button class="tab-btn active" data-tab="main">Kç·š</button>
                <button class="tab-btn" data-tab="macd">MACD</button>
                <button class="tab-btn" data-tab="kd">KD</button>
                <button class="tab-btn" data-tab="rsi">RSI</button>
                <button class="tab-btn" data-tab="mfi">MFI</button>
                <button class="tab-btn" data-tab="bias">ä¹–é›¢ç‡</button>
                <button class="tab-btn" data-tab="wr">å¨å»‰</button>
            </div>

            <!-- Kç·šåœ– -->
            <div class="tab-content active" id="tab-main">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>ğŸ“Š è‚¡åƒ¹èˆ‡å¸ƒæ—é€šé“</span>
                        <button class="btn btn-sm btn-warning" data-chart="main-chart">ğŸ“¥</button>
                    </div>
                    <div id="main-chart"></div>
                </div>
            </div>

            <!-- MACD -->
            <div class="tab-content" id="tab-macd">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>ğŸ“‰ MACD æŒ‡æ¨™</span>
                        <button class="btn btn-sm btn-warning" data-chart="macd-chart">ğŸ“¥</button>
                    </div>
                    <div id="macd-chart"></div>
                </div>
            </div>

            <!-- KD -->
            <div class="tab-content" id="tab-kd">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>ğŸ“ˆ KD éš¨æ©ŸæŒ‡æ¨™</span>
                        <button class="btn btn-sm btn-warning" data-chart="kd-chart">ğŸ“¥</button>
                    </div>
                    <div id="kd-chart"></div>
                </div>
            </div>

            <!-- RSI -->
            <div class="tab-content" id="tab-rsi">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>ğŸ’ª RSI ç›¸å°å¼·å¼±</span>
                        <button class="btn btn-sm btn-warning" data-chart="rsi-chart">ğŸ“¥</button>
                    </div>
                    <div id="rsi-chart"></div>
                </div>
            </div>

            <!-- MFI -->
            <div class="tab-content" id="tab-mfi">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>ğŸ’° MFI è³‡é‡‘æµé‡</span>
                        <button class="btn btn-sm btn-warning" data-chart="mfi-chart">ğŸ“¥</button>
                    </div>
                    <div id="mfi-chart"></div>
                </div>
            </div>

            <!-- BIAS -->
            <div class="tab-content" id="tab-bias">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>ğŸ“ ä¹–é›¢ç‡ BIAS</span>
                        <button class="btn btn-sm btn-warning" data-chart="bias-chart">ğŸ“¥</button>
                    </div>
                    <div id="bias-chart"></div>
                </div>
            </div>

            <!-- Williams %R -->
            <div class="tab-content" id="tab-wr">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>ğŸ¯ å¨å»‰æŒ‡æ¨™ %R</span>
                        <button class="btn btn-sm btn-warning" data-chart="wr-chart">ğŸ“¥</button>
                    </div>
                    <div id="wr-chart"></div>
                </div>
            </div>

            <!-- è³‡æ–™è¡¨æ ¼ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon purple">ğŸ“‹</div>
                        äº¤æ˜“æ˜ç´°
                    </div>
                    <button class="btn btn-sm btn-success" id="exportCsvBtn">åŒ¯å‡º</button>
                </div>
                <div class="data-table-container" style="max-height: 300px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>é–‹ç›¤</th>
                                <th>æœ€é«˜</th>
                                <th>æœ€ä½</th>
                                <th>æ”¶ç›¤</th>
                                <th>æ¼²è·Œ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr><td colspan="6" style="text-align: center;">è«‹å…ˆè¼‰å…¥è³‡æ–™</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========== AI åˆ†æé  ========== -->
        <div class="page" id="page-ai">
            <!-- AI å­åˆ†é  -->
            <div class="sub-tabs" id="aiSubTabs">
                <button class="sub-tab active" data-subtab="ai-smart">ğŸ¤– æ™ºæ…§åˆ†æ</button>
                <button class="sub-tab" data-subtab="ai-expert">ğŸ‘¨â€ğŸ’¼ å°ˆå®¶å»ºè­°</button>
                <button class="sub-tab" data-subtab="ai-pattern">ğŸ“Š å‹æ…‹è¾¨è­˜</button>
                <button class="sub-tab" data-subtab="ai-financial">ğŸ“‘ è²¡å ±åˆ†æ</button>
                <button class="sub-tab" data-subtab="ai-qa">â“ ç¶²è·¯å•ç­”</button>
                <button class="sub-tab" data-subtab="ai-overview">ğŸ“‹ å€‹è‚¡æ¦‚æ³</button>
                <button class="sub-tab" data-subtab="ai-trump">ğŸ‡ºğŸ‡¸ å·æ™®ä¸€å¥è©±</button>
                <button class="sub-tab" data-subtab="ai-us">ğŸ—½ ç¾è‚¡åˆ†æ</button>
            </div>

            <!-- AI æ™ºæ…§åˆ†æ -->
            <div class="tab-content active" id="subtab-ai-smart">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon purple">ğŸ¤–</div>
                            AI æ™ºæ…§åˆ†æ
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">åˆ†ææ¨¡å‹</label>
                        <select id="analysisType">
                            <option value="summary">ğŸ“ ç¸½é«”æ‘˜è¦</option>
                            <option value="technical">ğŸ“Š æŠ€è¡“æŒ‡æ¨™åˆ†æ</option>
                            <option value="fundamental">ğŸ’¼ åŸºæœ¬é¢è§£è®€</option>
                            <option value="news">ğŸ“° å¸‚å ´æ–°èæƒ…ç·’</option>
                            <option value="future">ğŸ”® æœªä¾†è¶¨å‹¢é æ¸¬</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-block" id="analyzeBtn">ğŸš€ å•Ÿå‹•åˆ†æ</button>
                    <div class="loader" id="aiSmartLoader"></div>
                    <div id="aiSmartResult" style="display: none;">
                        <div class="ai-result" id="aiResultText"></div>
                        <div class="btn-group" style="margin-top: 10px;">
                            <button class="btn btn-sm btn-success" id="ttsBtn" style="display: none;">ğŸ”Š æ’­æ”¾</button>
                            <button class="btn btn-sm btn-warning" id="downloadAiMd" style="display: none;">ğŸ“¥ MD</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI å°ˆå®¶å»ºè­° -->
            <div class="tab-content" id="subtab-ai-expert">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon gold">ğŸ‘¨â€ğŸ’¼</div>
                            AI å°ˆå®¶å»ºè­°
                        </div>
                    </div>
                    <button class="btn btn-primary btn-block" id="expertAdviceBtn">ğŸ¯ ç”Ÿæˆå°ˆå®¶å»ºè­°</button>
                    <div class="loader" id="expertLoader"></div>
                    <div id="expertResult" style="display: none;">
                        <div class="ai-result" id="expertResultText"></div>
                        <div class="btn-group" style="margin-top: 10px;">
                            <button class="btn btn-sm btn-danger" id="downloadPdfBtn">ğŸ“„ PDF</button>
                            <button class="btn btn-sm btn-warning" id="downloadExpertMd">ğŸ“¥ MD</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI å‹æ…‹è¾¨è­˜ -->
            <div class="tab-content" id="subtab-ai-pattern">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon blue">ğŸ“Š</div>
                            AI Kç·šå‹æ…‹è¾¨è­˜
                        </div>
                    </div>
                    <button class="btn btn-primary btn-block" id="patternBtn">ğŸ” è¾¨è­˜å‹æ…‹</button>
                    <div class="loader" id="patternLoader"></div>
                    <div id="patternResult" style="display: none;">
                        <div class="ai-result" id="patternResultText"></div>
                        <div class="chart-container" id="patternChartContainer" style="margin-top: 10px;">
                            <div id="pattern-chart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI è²¡å ±åˆ†æ -->
            <div class="tab-content" id="subtab-ai-financial">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon green">ğŸ“‘</div>
                            AI è²¡å ±åˆ†æ
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è²¼ä¸Šè²¡å ±æˆ–æ³•èªªæœƒå…§å®¹</label>
                        <textarea id="financialTextInput" rows="6" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šå®Œæ•´çš„è²¡å ±ã€æ³•èªªæœƒæˆ–æ–°èç¨¿å…§å®¹..."></textarea>
                    </div>
                    <button class="btn btn-danger btn-block" id="financialBtn">ğŸ“Š å•Ÿå‹•è²¡å ±åˆ†æ</button>
                    <div class="loader" id="financialLoader"></div>
                    <div id="financialResult" style="display: none;">
                        <div class="ai-result" id="financialResultText"></div>
                    </div>
                </div>
            </div>

            <!-- ç¶²è·¯å•ç­” -->
            <div class="tab-content" id="subtab-ai-qa">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon orange">â“</div>
                            å€‹è‚¡ç¶²è·¯å•ç­”
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é‡å°ç›®å‰å€‹è‚¡æå•</label>
                        <input type="text" id="qaInput" placeholder="ä¾‹å¦‚ï¼šæœ€è¿‘æœ‰ä»€éº¼é‡è¦è²¡å ±å—ï¼Ÿ">
                    </div>
                    <button class="btn btn-primary btn-block" id="qaBtn">ğŸŒ ç¶²è·¯æå•</button>
                    <div class="loader" id="qaLoader"></div>
                    <div id="qaResult" style="display: none;">
                        <div class="ai-result" id="qaResultText"></div>
                        <div class="citations" id="qaCitations"></div>
                    </div>
                </div>
            </div>

            <!-- å€‹è‚¡æ¦‚æ³ -->
            <div class="tab-content" id="subtab-ai-overview">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon teal">ğŸ“‹</div>
                            å€‹è‚¡æ¦‚æ³åˆ†æ
                        </div>
                    </div>
                    <button class="btn btn-primary btn-block" id="overviewBtn">ğŸ“Š åˆ†ææ¦‚æ³</button>
                    <div class="loader" id="overviewLoader"></div>
                    <div id="overviewResult" style="display: none;">
                        <div class="ai-result" id="overviewResultText"></div>
                    </div>
                </div>
            </div>

            <!-- å·æ™®ä¸€å¥è©± -->
            <div class="tab-content" id="subtab-ai-trump">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon red">ğŸ‡ºğŸ‡¸</div>
                            å·æ™®ä¸€å¥è©±åˆ†æ
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¼¸å…¥å·æ™®çš„è¨€è«– (ç•™ç©ºå¯è‡ªå‹•æœå°‹)</label>
                        <textarea id="trumpQuoteInput" rows="3" placeholder="è«‹è¼¸å…¥å·æ™®çš„ä¸€å¥è©±..."></textarea>
                    </div>
                    <button class="btn btn-primary btn-block" id="trumpBtn">ğŸ” åˆ†æå½±éŸ¿</button>
                    <div class="loader" id="trumpLoader"></div>
                    <div id="trumpResult" style="display: none;">
                        <div class="ai-result" id="trumpResultText"></div>
                    </div>
                </div>
            </div>

            <!-- ç¾è‚¡åˆ†æ -->
            <div class="tab-content" id="subtab-ai-us">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon pink">ğŸ—½</div>
                            ç¾è‚¡ç›¤å¾Œåˆ†æ
                        </div>
                    </div>
                    <button class="btn btn-primary btn-block" id="usMarketBtn">ğŸ“ˆ å•Ÿå‹•ç¾è‚¡åˆ†æ</button>
                    <div class="loader" id="usMarketLoader"></div>
                    <div id="usMarketResult" style="display: none;">
                        <div class="ai-result" id="usMarketResultText"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== å·¥å…·é  ========== -->
        <div class="page" id="page-tools">
            <!-- å·¥å…·å­åˆ†é  -->
            <div class="sub-tabs" id="toolSubTabs">
                <button class="sub-tab active" data-subtab="tool-pk">âš”ï¸ å€‹è‚¡ PK</button>
                <button class="sub-tab" data-subtab="tool-backtest">ğŸ”„ ç­–ç•¥å›æ¸¬</button>
                <button class="sub-tab" data-subtab="tool-query">ğŸ” æœˆåº¦æŸ¥è©¢</button>
            </div>

            <!-- å€‹è‚¡ PK -->
            <div class="tab-content active" id="subtab-tool-pk">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon red">âš”ï¸</div>
                            å€‹è‚¡æ¯”è¼ƒ (PK)
                        </div>
                    </div>
                    <div class="btn-group" style="margin-bottom: 10px;">
                        <input type="text" id="pkCode1" placeholder="ä»£è™Ÿ 1" style="flex: 1;">
                        <input type="text" id="pkCode2" placeholder="ä»£è™Ÿ 2" style="flex: 1;">
                    </div>
                    <div class="btn-group" style="margin-bottom: 10px;">
                        <input type="text" id="pkCode3" placeholder="ä»£è™Ÿ 3 (é¸å¡«)" style="flex: 1;">
                        <input type="text" id="pkCode4" placeholder="ä»£è™Ÿ 4 (é¸å¡«)" style="flex: 1;">
                    </div>
                    <div class="btn-group" style="margin-bottom: 10px;">
                        <input type="date" id="pkStartDate" style="flex: 1;">
                        <input type="date" id="pkEndDate" style="flex: 1;">
                    </div>
                    <button class="btn btn-primary btn-block" id="pkCompareBtn">ğŸ“Š é–‹å§‹æ¯”è¼ƒ</button>
                    <div class="loader" id="pkLoader"></div>
                    <div id="pkStatus"></div>
                    <div class="chart-container" id="pkChartContainer" style="display: none;">
                        <div id="pk-chart"></div>
                    </div>
                </div>
            </div>

            <!-- ç­–ç•¥å›æ¸¬ -->
            <div class="tab-content" id="subtab-tool-backtest">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon blue">ğŸ”„</div>
                            ç­–ç•¥å›æ¸¬ (MA é»ƒé‡‘äº¤å‰)
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">åˆå§‹è³‡é‡‘ (NT$)</label>
                        <input type="number" id="initialCapital" value="1000000">
                    </div>
                    <button class="btn btn-primary btn-block" id="backtestBtn">ğŸš€ é–‹å§‹å›æ¸¬</button>
                    <div class="loader" id="backtestLoader"></div>
                    <div id="backtestResult" style="display: none;">
                        <div class="backtest-summary" id="backtestSummary"></div>
                        <div class="chart-container">
                            <div id="backtest-chart"></div>
                        </div>
                        <div class="data-table-container" style="max-height: 200px; margin-top: 10px;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>è²·å…¥æ—¥</th>
                                        <th>è²·åƒ¹</th>
                                        <th>è³£å‡ºæ—¥</th>
                                        <th>è³£åƒ¹</th>
                                        <th>å ±é…¬</th>
                                    </tr>
                                </thead>
                                <tbody id="backtestTradesBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœˆåº¦æŸ¥è©¢ -->
            <div class="tab-content" id="subtab-tool-query">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon green">ğŸ”</div>
                            æœˆåº¦è³‡æ–™æŸ¥è©¢
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="text" id="monthlyStockCode" placeholder="è‚¡ç¥¨ä»£è™Ÿ">
                    </div>
                    <div class="btn-group" style="margin-bottom: 10px;">
                        <select id="queryYear" style="flex: 1;"></select>
                        <select id="queryMonth" style="flex: 1;"></select>
                    </div>
                    <button class="btn btn-primary btn-block" id="monthlyQueryBtn">ğŸ” æŸ¥è©¢</button>
                    <div class="loader" id="monthlyLoader"></div>
                    <div id="monthlyQueryStatus"></div>
                    <div class="data-table-container" style="max-height: 300px; margin-top: 10px; display: none;" id="monthlyDataContainer">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>é–‹ç›¤</th>
                                    <th>æœ€é«˜</th>
                                    <th>æœ€ä½</th>
                                    <th>æ”¶ç›¤</th>
                                    <th>æ¼²è·Œ</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyDataBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== è¨­å®šé  ========== -->
        <div class="page" id="page-settings">
            <!-- API Key è¨­å®š -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon purple">ğŸ”‘</div>
                        Gemini API è¨­å®š
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ‚¨çš„ API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="è«‹è¼¸å…¥ Gemini API Key">
                </div>
                <button class="btn btn-primary btn-block" id="validateApiKeyBtn">ğŸ” é©—è­‰ä¸¦å„²å­˜</button>
                <div id="apiKeyStatus"></div>
            </div>

            <!-- è³‡æ–™ç®¡ç† -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon orange">ğŸ’¾</div>
                        è³‡æ–™ç®¡ç†
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" id="exportAllDataBtn" style="flex: 1;">ğŸ“¥ åŒ¯å‡º CSV</button>
                    <button class="btn btn-danger" id="clearDataBtn" style="flex: 1;">ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™</button>
                </div>
            </div>

            <!-- é—œæ–¼ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon teal">â„¹ï¸</div>
                        é—œæ–¼
                    </div>
                </div>
                <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                    ğŸ“ˆ <strong>è‚¡å¸‚å¤§å¸« Pro</strong><br>
                    ç‰ˆæœ¬ï¼šv1.0<br>
                    è³‡æ–™ä¾†æºï¼šå°ç£è­‰åˆ¸äº¤æ˜“æ‰€<br><br>
                    åŠŸèƒ½åŒ…å«ï¼šå³æ™‚è‚¡åƒ¹æŸ¥è©¢ã€æŠ€è¡“æŒ‡æ¨™åˆ†æã€AI æ™ºæ…§åˆ†æã€ç­–ç•¥å›æ¸¬ç­‰ã€‚<br><br>
                    âš ï¸ æœ¬å·¥å…·åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚
                </p>
            </div>

            <!-- ä½¿ç”¨èªªæ˜ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon blue">ğŸ“–</div>
                        ä½¿ç”¨èªªæ˜
                    </div>
                </div>
                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                    <p><strong>1ï¸âƒ£ å¿«é€ŸæŸ¥è©¢</strong>ï¼šè¼¸å…¥è‚¡ç¥¨ä»£è™Ÿå’Œæ—¥æœŸç¯„åœ</p>
                    <p><strong>2ï¸âƒ£ æŠ€è¡“åˆ†æ</strong>ï¼šæŸ¥çœ‹ K ç·šã€MACDã€KD ç­‰æŒ‡æ¨™</p>
                    <p><strong>3ï¸âƒ£ AI åˆ†æ</strong>ï¼šéœ€å…ˆè¨­å®š Gemini API Key</p>
                    <p><strong>4ï¸âƒ£ ç­–ç•¥å›æ¸¬</strong>ï¼šæ¸¬è©¦ MA é»ƒé‡‘äº¤å‰ç­–ç•¥</p>
                    <p><strong>5ï¸âƒ£ å€‹è‚¡ PK</strong>ï¼šæ¯”è¼ƒå¤šæª”è‚¡ç¥¨èµ°å‹¢</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <div class="bottom-nav">
        <div class="nav-item active" data-page="home">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">é¦–é </span>
        </div>
        <div class="nav-item" data-page="chart">
            <span class="nav-icon">ğŸ“ˆ</span>
            <span class="nav-label">åœ–è¡¨</span>
        </div>
        <div class="nav-item" data-page="ai">
            <span class="nav-icon">ğŸ¤–</span>
            <span class="nav-label">AI</span>
        </div>
        <div class="nav-item" data-page="tools">
            <span class="nav-icon">ğŸ› ï¸</span>
            <span class="nav-label">å·¥å…·</span>
        </div>
        <div class="nav-item" data-page="settings">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-label">è¨­å®š</span>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div class="toast" id="toast"></div>

    <!-- æ–°å¢è‡ªé¸è‚¡ Modal -->
    <div class="modal-overlay" id="addWatchlistModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">æ–°å¢è‡ªé¸è‚¡</span>
                <button class="modal-close" onclick="closeModal('addWatchlistModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">è‚¡ç¥¨ä»£è™Ÿ</label>
                    <input type="text" id="watchlistAddInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ (å¦‚: 2330)">
                </div>
                <button class="btn btn-primary btn-block" id="confirmAddWatchlist">ç¢ºèªæ–°å¢</button>
                <div class="loader" id="watchlistAddLoader"></div>
                <div id="watchlistAddStatus"></div>
            </div>
        </div>
    </div>

<script>
// ============================================
// å…¨åŸŸè®Šæ•¸
// ============================================
let originalStockData = [];
let userApiKey = '';
let watchlist = [];
let charts = {};
let currentPeriod = 'day';

// ============================================
// åˆå§‹åŒ–
// ============================================
window.onload = function() {
    initDates();
    populateDateSelects();
    loadWatchlist();
    renderWatchlist();
    loadStoredData();
    loadApiKey();
    updateStatusTime();
    setInterval(updateStatusTime, 60000);
    
    // å¦‚æœæœ‰å„²å­˜çš„è³‡æ–™ï¼Œé¡¯ç¤º
    if (originalStockData.length > 0) {
        processAndDisplayData();
    }
};

function updateStatusTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('statusTime').textContent = timeStr;
}

function initDates() {
    const today = new Date();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(today.getMonth() - 3);
    
    document.getElementById('startDateInput').value = threeMonthsAgo.toISOString().split('T')[0];
    document.getElementById('endDateInput').value = today.toISOString().split('T')[0];
    document.getElementById('pkStartDate').value = threeMonthsAgo.toISOString().split('T')[0];
    document.getElementById('pkEndDate').value = today.toISOString().split('T')[0];
}

function populateDateSelects() {
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;
    
    const yearSelect = document.getElementById('queryYear');
    const monthSelect = document.getElementById('queryMonth');
    
    for (let year = currentYear; year >= 2000; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + ' å¹´';
        yearSelect.appendChild(option);
    }
    
    for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month + ' æœˆ';
        monthSelect.appendChild(option);
    }
    
    yearSelect.value = currentYear;
    monthSelect.value = currentMonth;
}

// ============================================
// é é¢åˆ‡æ›
// ============================================
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
        const page = this.dataset.page;
        
        // æ›´æ–°å°èˆª
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        this.classList.add('active');
        
        // åˆ‡æ›é é¢
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + page).classList.add('active');
        
        // å¦‚æœåˆ‡æ›åˆ°åœ–è¡¨é ï¼Œé‡æ–°æ¸²æŸ“
        if (page === 'chart' && originalStockData.length > 0) {
            setTimeout(() => updateCharts(currentPeriod), 100);
        }
    });
});

// åœ–è¡¨æ¨™ç±¤åˆ‡æ›
document.getElementById('chartTabs').addEventListener('click', function(e) {
    if (e.target.classList.contains('tab-btn')) {
        const tab = e.target.dataset.tab;
        
        document.querySelectorAll('#chartTabs .tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        document.querySelectorAll('#page-chart .tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        
        if (originalStockData.length > 0) {
            setTimeout(() => updateCharts(currentPeriod), 50);
        }
    }
});

// é€±æœŸé¸æ“‡
document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentPeriod = this.dataset.period;
        if (originalStockData.length > 0) {
            updateCharts(currentPeriod);
        }
    });
});

// AI å­åˆ†é åˆ‡æ›
document.getElementById('aiSubTabs').addEventListener('click', function(e) {
    if (e.target.classList.contains('sub-tab')) {
        const subtab = e.target.dataset.subtab;
        
        document.querySelectorAll('#aiSubTabs .sub-tab').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        document.querySelectorAll('#page-ai .tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('subtab-' + subtab).classList.add('active');
    }
});

// å·¥å…·å­åˆ†é åˆ‡æ›
document.getElementById('toolSubTabs').addEventListener('click', function(e) {
    if (e.target.classList.contains('sub-tab')) {
        const subtab = e.target.dataset.subtab;
        
        document.querySelectorAll('#toolSubTabs .sub-tab').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        document.querySelectorAll('#page-tools .tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('subtab-' + subtab).classList.add('active');
    }
});

// ============================================
// Toast é€šçŸ¥
// ============================================
function showToast(message, duration = 2000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), duration);
}

// ============================================
// Modal æ§åˆ¶
// ============================================
function openModal(id) {
    document.getElementById(id).classList.add('show');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

document.getElementById('addWatchlistBtn').addEventListener('click', () => openModal('addWatchlistModal'));

// ============================================
// è³‡æ–™ç²å– - å°ç£è­‰åˆ¸äº¤æ˜“æ‰€ API
// ============================================
async function fetchDataForMonth(stockCode, month) {
    const dateStr = `${month}01`;
    const apiUrl = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${stockCode}`;
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;
    
    await new Promise(resolve => setTimeout(resolve, 500)); // Rate limiting
    
    const response = await fetch(proxyUrl);
    if (!response.ok) throw new Error(`è«‹æ±‚å¤±æ•— (${response.status})`);
    
    return response.json();
}

function getMonthsInRange(startDate, endDate) {
    const months = new Set();
    let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const lastDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    
    while (currentDate <= lastDate) {
        const year = currentDate.getFullYear();
        const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
        months.add(`${year}${month}`);
        currentDate.setMonth(currentDate.getMonth() + 1);
    }
    return Array.from(months);
}

function filterAndFormatData(data, startDate, endDate) {
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999);
    
    return data.map(item => {
        const rocDate = item[0].trim();
        const [rocYear, month, day] = rocDate.split('/');
        const year = parseInt(rocYear, 10) + 1911;
        const gregorianDate = new Date(year, parseInt(month, 10) - 1, parseInt(day, 10));
        gregorianDate.setHours(0, 0, 0, 0);
        return { dateObj: gregorianDate, rocDate: rocDate, data: item };
    }).filter(item => item.dateObj >= start && item.dateObj <= end)
      .sort((a, b) => a.dateObj - b.dateObj);
}

function transformTwseData(twseData, stockInfo) {
    return twseData.map(item => {
        const d = item.data;
        const year = item.dateObj.getFullYear();
        const month = String(item.dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(item.dateObj.getDate()).padStart(2, '0');
        return {
            rocDate: item.rocDate,
            stockCode: stockInfo.code,
            stockName: stockInfo.name,
            date: `${year}-${month}-${day}`,
            volume: parseInt(String(d[1]).replace(/,/g, ''), 10),
            amount: parseInt(String(d[2]).replace(/,/g, ''), 10),
            open: parseFloat(String(d[3]).replace(/,/g, '')),
            high: parseFloat(String(d[4]).replace(/,/g, '')),
            low: parseFloat(String(d[5]).replace(/,/g, '')),
            close: parseFloat(String(d[6]).replace(/,/g, '')),
            change: String(d[7]).replace(/,/g, ''),
            transactions: parseInt(String(d[8]).replace(/,/g, ''), 10)
        };
    });
}

async function fetchStockData(stockCode, startDate, endDate) {
    const months = getMonthsInRange(new Date(startDate), new Date(endDate));
    const fetchPromises = months.map(month => fetchDataForMonth(stockCode, month));
    const monthlyResults = await Promise.all(fetchPromises);
    
    let allData = [];
    let stockInfo = { code: stockCode, name: '' };
    
    monthlyResults.forEach(result => {
        if (result && result.stat === "OK" && result.data) {
            allData.push(...result.data);
            if (!stockInfo.name && result.title) {
                stockInfo.name = result.title.split(' ')[2];
            }
        }
    });
    
    if (allData.length === 0) {
        throw new Error(`æ‰¾ä¸åˆ° ${stockCode} çš„è³‡æ–™ï¼Œè«‹ç¢ºèªä»£è™Ÿæ˜¯å¦æ­£ç¢º`);
    }
    
    const filteredData = filterAndFormatData(allData, startDate, endDate);
    
    if (filteredData.length === 0) {
        throw new Error('é¸æ“‡çš„æ—¥æœŸç¯„åœå…§æ²’æœ‰äº¤æ˜“è³‡æ–™');
    }
    
    return transformTwseData(filteredData, stockInfo);
}

// ============================================
// ä¸»è¦æŸ¥è©¢åŠŸèƒ½
// ============================================
document.getElementById('fetchDataBtn').addEventListener('click', async function() {
    const stockCode = document.getElementById('stockCodeInput').value.trim();
    const startDate = document.getElementById('startDateInput').value;
    const endDate = document.getElementById('endDateInput').value;
    
    if (!stockCode || !startDate || !endDate) {
        showToast('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        showToast('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
        return;
    }
    
    const loader = document.getElementById('homeLoader');
    const status = document.getElementById('queryStatus');
    
    loader.classList.add('show');
    status.innerHTML = '<div class="status-msg info">æ­£åœ¨æŸ¥è©¢è³‡æ–™...</div>';
    
    try {
        const data = await fetchStockData(stockCode, startDate, endDate);
        originalStockData = data;
        saveDataToStorage();
        processAndDisplayData();
        
        status.innerHTML = `<div class="status-msg success">âœ… æˆåŠŸè¼‰å…¥ ${data[0].stockName} (${data[0].stockCode}) ${data.length} ç­†è³‡æ–™</div>`;
        showToast('è³‡æ–™è¼‰å…¥æˆåŠŸï¼');
        
    } catch (error) {
        status.innerHTML = `<div class="status-msg error">âŒ ${error.message}</div>`;
        showToast('æŸ¥è©¢å¤±æ•—ï¼š' + error.message);
    } finally {
        loader.classList.remove('show');
    }
});

// ============================================
// CSV ä¸Šå‚³
// ============================================
document.getElementById('csvFileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type === 'text/csv') {
        const reader = new FileReader();
        reader.onload = function(e) {
            const csvText = e.target.result;
            const parsedData = parseCsv(csvText);
            if (parsedData.length > 0) {
                originalStockData = parsedData;
                saveDataToStorage();
                processAndDisplayData();
                showToast('CSV åŒ¯å…¥æˆåŠŸï¼');
            } else {
                showToast('ç„¡æ³•è§£æ CSV æª”æ¡ˆ');
            }
        };
        reader.readAsText(file);
    } else {
        showToast('è«‹ä¸Šå‚³ CSV æ ¼å¼çš„æª”æ¡ˆ');
    }
});

function parseCsv(csvText) {
    const lines = csvText.trim().split('\n');
    let dataStartIndex = 0;
    while(dataStartIndex < lines.length && !/^\d{3}\/\d{2}\/\d{2}/.test(lines[dataStartIndex])) {
        dataStartIndex++;
    }
    
    const data = [];
    const stockInfo = { code: 'N/A', name: 'N/A' };
    
    if (dataStartIndex > 0) {
        const headerLine = lines[dataStartIndex-2] || "";
        const match = headerLine.match(/(\d{4,})\s(.+?),/);
        if (match) {
            stockInfo.code = match[1];
            stockInfo.name = match[2].trim();
        }
    }
    
    for (let i = dataStartIndex; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        if (values.length >= 9) {
            const [rocDate, volume, amount, open, high, low, close, change, transactions] = values;
            const [rocYear, month, day] = rocDate.split('/');
            const year = parseInt(rocYear, 10) + 1911;
            
            data.push({
                rocDate: rocDate,
                stockCode: stockInfo.code,
                stockName: stockInfo.name,
                date: new Date(year, month - 1, day).toISOString().split('T')[0],
                volume: parseInt(volume.replace(/,/g, '')),
                amount: parseInt(amount.replace(/,/g, '')),
                open: parseFloat(open.replace(/,/g, '')),
                high: parseFloat(high.replace(/,/g, '')),
                low: parseFloat(low.replace(/,/g, '')),
                close: parseFloat(close.replace(/,/g, '')),
                change: change.replace(/,/g, ''),
                transactions: parseInt(transactions.replace(/,/g, ''))
            });
        }
    }
    return data;
}

// ============================================
// è‡ªé¸è‚¡åŠŸèƒ½
// ============================================
function loadWatchlist() {
    const stored = localStorage.getItem('stockWatchlist');
    if (stored) {
        watchlist = JSON.parse(stored);
    }
}

function saveWatchlist() {
    localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
}

function renderWatchlist() {
    const container = document.getElementById('watchlistContainer');
    
    if (watchlist.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="icon">ğŸ“‹</div>
                <p>å°šç„¡è‡ªé¸è‚¡</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = watchlist.map(stock => `
        <div class="watchlist-item" data-code="${stock.code}">
            <div class="stock-info">
                <span class="stock-name">${stock.name}</span>
                <span class="stock-code">${stock.code}</span>
            </div>
            <button class="remove-btn" data-code="${stock.code}">Ã—</button>
        </div>
    `).join('');
    
    // é»æ“ŠæŸ¥è©¢
    container.querySelectorAll('.watchlist-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (!e.target.classList.contains('remove-btn')) {
                const code = this.dataset.code;
                document.getElementById('stockCodeInput').value = code;
                document.getElementById('fetchDataBtn').click();
            }
        });
    });
    
    // åˆªé™¤
    container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const code = this.dataset.code;
            watchlist = watchlist.filter(s => s.code !== code);
            saveWatchlist();
            renderWatchlist();
            showToast('å·²ç§»é™¤è‡ªé¸è‚¡');
        });
    });
}

async function getStockName(code) {
    const today = new Date();
    const monthStr = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}`;
    const result = await fetchDataForMonth(code, monthStr);
    if (result && result.stat === "OK" && result.title) {
        const parts = result.title.split(' ');
        if (parts.length > 2) {
            return parts[2];
        }
    }
    throw new Error('æ‰¾ä¸åˆ°è©²è‚¡ç¥¨');
}

document.getElementById('confirmAddWatchlist').addEventListener('click', async function() {
    const code = document.getElementById('watchlistAddInput').value.trim();
    const loader = document.getElementById('watchlistAddLoader');
    const status = document.getElementById('watchlistAddStatus');
    
    if (!code || !/^\d{4,6}$/.test(code)) {
        status.innerHTML = '<div class="status-msg error">è«‹è¼¸å…¥æœ‰æ•ˆçš„è‚¡ç¥¨ä»£è™Ÿ</div>';
        return;
    }
    
    if (watchlist.some(s => s.code === code)) {
        status.innerHTML = '<div class="status-msg error">æ­¤è‚¡ç¥¨å·²åœ¨è‡ªé¸è‚¡ä¸­</div>';
        return;
    }
    
    loader.classList.add('show');
    status.innerHTML = '';
    
    try {
        const name = await getStockName(code);
        watchlist.push({ code, name });
        watchlist.sort((a, b) => a.code.localeCompare(b.code));
        saveWatchlist();
        renderWatchlist();
        
        document.getElementById('watchlistAddInput').value = '';
        closeModal('addWatchlistModal');
        showToast(`å·²æ–°å¢ ${name}`);
        
    } catch (error) {
        status.innerHTML = `<div class="status-msg error">${error.message}</div>`;
    } finally {
        loader.classList.remove('show');
    }
});

// ============================================
// è³‡æ–™è™•ç†èˆ‡é¡¯ç¤º
// ============================================
function processAndDisplayData() {
    if (!originalStockData || originalStockData.length === 0) return;
    
    updatePriceDisplay();
    updateDataTable();
    updateCharts(currentPeriod);
}

function updatePriceDisplay() {
    if (originalStockData.length === 0) return;
    
    const latest = originalStockData[originalStockData.length - 1];
    document.getElementById('displayStockName').textContent = latest.stockName || 'æœªçŸ¥';
    document.getElementById('displayStockCode').textContent = latest.stockCode || '--';
    document.getElementById('displayPrice').textContent = latest.close;
    
    const changeValue = parseFloat(latest.change);
    const changeEl = document.getElementById('displayChange');
    let changeText = latest.change;
    
    if (changeValue > 0) {
        changeText = '+' + changeText;
        changeEl.className = 'change text-rise';
    } else if (changeValue < 0) {
        changeEl.className = 'change text-fall';
    } else {
        changeEl.className = 'change';
    }
    
    changeEl.textContent = changeText;
}

function updateDataTable() {
    const tbody = document.getElementById('dataTableBody');
    
    if (originalStockData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">è«‹å…ˆè¼‰å…¥è³‡æ–™</td></tr>';
        return;
    }
    
    const reversedData = [...originalStockData].reverse();
    tbody.innerHTML = reversedData.map(d => {
        const changeValue = parseFloat(d.change);
        let changeClass = '';
        let changeText = d.change;
        
        if (changeValue > 0) {
            changeClass = 'text-rise';
            changeText = '+' + changeText;
        } else if (changeValue < 0) {
            changeClass = 'text-fall';
        }
        
        return `
            <tr>
                <td>${d.date}</td>
                <td>${d.open}</td>
                <td>${d.high}</td>
                <td>${d.low}</td>
                <td class="${changeClass}">${d.close}</td>
                <td class="${changeClass}">${changeText}</td>
            </tr>
        `;
    }).join('');
}

// ============================================
// æŠ€è¡“æŒ‡æ¨™è¨ˆç®—
// ============================================
function processStockData(data) {
    // MA
    const maPeriods = [5, 6, 10, 20];
    maPeriods.forEach(period => {
        for (let i = 0; i < data.length; i++) {
            if (i >= period - 1) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].close;
                }
                data[i]['ma' + period] = (sum / period).toFixed(2);
            } else {
                data[i]['ma' + period] = null;
            }
        }
    });
    
    // Bollinger Bands
    const bbPeriod = 20;
    const bbMultiplier = 2;
    for (let i = 0; i < data.length; i++) {
        if (i >= bbPeriod - 1) {
            const slice = data.slice(i - bbPeriod + 1, i + 1);
            const mean = parseFloat(data[i].ma20);
            const stdDev = Math.sqrt(slice.map(d => Math.pow(d.close - mean, 2)).reduce((a, b) => a + b) / bbPeriod);
            data[i].bb_upper = (mean + (stdDev * bbMultiplier)).toFixed(2);
            data[i].bb_lower = (mean - (stdDev * bbMultiplier)).toFixed(2);
        } else {
            data[i].bb_upper = null;
            data[i].bb_lower = null;
        }
    }
    
    // BIAS
    for (let i = 0; i < data.length; i++) {
        if (data[i].ma6) {
            data[i].bias = (((data[i].close - data[i].ma6) / data[i].ma6) * 100).toFixed(2);
        } else {
            data[i].bias = null;
        }
    }
    
    // RSI
    let gains = 0, losses = 0;
    const rsiPeriod = 14;
    for (let i = 1; i < data.length; i++) {
        const change = data[i].close - data[i - 1].close;
        if (i < rsiPeriod) {
            if (change > 0) gains += change;
            else losses -= change;
        } else if (i === rsiPeriod) {
            gains /= rsiPeriod;
            losses /= rsiPeriod;
        } else {
            if (change > 0) gains = (gains * (rsiPeriod - 1) + change) / rsiPeriod;
            else losses = (losses * (rsiPeriod - 1) - change) / rsiPeriod;
        }
        if (i >= rsiPeriod - 1) {
            const rs = losses === 0 ? 100 : gains / losses;
            data[i].rsi = (100 - (100 / (1 + rs))).toFixed(2);
        } else {
            data[i].rsi = null;
        }
    }
    
    // MFI
    const mfiPeriod = 14;
    for (let i = 0; i < data.length; i++) {
        data[i].mfi = null;
        if (i > 0) {
            const typicalPrice = (data[i].high + data[i].low + data[i].close) / 3;
            const prevTypicalPrice = (data[i-1].high + data[i-1].low + data[i-1].close) / 3;
            const rawMoneyFlow = typicalPrice * data[i].volume;
            data[i].positiveMoneyFlow = (typicalPrice > prevTypicalPrice) ? rawMoneyFlow : 0;
            data[i].negativeMoneyFlow = (typicalPrice < prevTypicalPrice) ? rawMoneyFlow : 0;
        } else {
            data[i].positiveMoneyFlow = 0;
            data[i].negativeMoneyFlow = 0;
        }
    }
    
    for (let i = mfiPeriod; i < data.length; i++) {
        let positiveSum = 0, negativeSum = 0;
        for (let j = 0; j < mfiPeriod; j++) {
            positiveSum += data[i - j].positiveMoneyFlow || 0;
            negativeSum += data[i - j].negativeMoneyFlow || 0;
        }
        if (negativeSum === 0) {
            data[i].mfi = 100;
        } else {
            const moneyRatio = positiveSum / negativeSum;
            data[i].mfi = (100 - (100 / (1 + moneyRatio))).toFixed(2);
        }
    }
    
    // Williams %R
    const wrPeriod = 14;
    for (let i = 0; i < data.length; i++) {
        if (i >= wrPeriod - 1) {
            const slice = data.slice(i - wrPeriod + 1, i + 1);
            const highestHigh = Math.max(...slice.map(d => d.high));
            const lowestLow = Math.min(...slice.map(d => d.low));
            const range = highestHigh - lowestLow;
            if (range === 0) {
                data[i].williamsR = -50;
            } else {
                data[i].williamsR = (((highestHigh - data[i].close) / range) * -100).toFixed(2);
            }
        } else {
            data[i].williamsR = null;
        }
    }
    
    // KD
    const kdPeriod = 9;
    let lowestLows = [], highestHighs = [];
    for (let i = 0; i < data.length; i++) {
        let periodData = data.slice(Math.max(0, i - kdPeriod + 1), i + 1);
        lowestLows[i] = Math.min(...periodData.map(d => d.low));
        highestHighs[i] = Math.max(...periodData.map(d => d.high));
    }
    
    for (let i = 0; i < data.length; i++) {
        data[i].k = null;
        data[i].d = null;
        if (i > 0) {
            const range = highestHighs[i] - lowestLows[i];
            const rsv = range === 0 ? 0 : ((data[i].close - lowestLows[i]) / range) * 100;
            const prevK = data[i-1].k === null ? 50 : parseFloat(data[i-1].k);
            data[i].k = (prevK * 2/3) + (rsv * 1/3);
            const prevD = data[i-1].d === null ? 50 : parseFloat(data[i-1].d);
            data[i].d = (prevD * 2/3) + (data[i].k * 1/3);
            data[i].k = data[i].k.toFixed(2);
            data[i].d = data[i].d.toFixed(2);
        }
    }
    
    // MACD
    const ema = (data, period) => {
        let emaValues = [];
        if (data.length < period) return emaValues;
        let multiplier = 2 / (period + 1);
        emaValues[period - 1] = data.slice(0, period).reduce((sum, d) => sum + d.close, 0) / period;
        for (let i = period; i < data.length; i++) {
            emaValues[i] = (data[i].close - emaValues[i-1]) * multiplier + emaValues[i-1];
        }
        return emaValues;
    };
    
    const ema12 = ema(data, 12);
    const ema26 = ema(data, 26);
    
    for (let i = 0; i < data.length; i++) {
        if (ema12[i] && ema26[i]) {
            data[i].macd = (ema12[i] - ema26[i]).toFixed(2);
        } else {
            data[i].macd = null;
        }
    }
    
    const macdData = data.filter(d => d.macd !== null);
    const signalEma = ema(macdData.map(d => ({close: parseFloat(d.macd)})), 9);
    
    let signalIndex = 0;
    for (let i = 0; i < data.length; i++) {
        if (data[i].macd !== null) {
            if (signalEma[signalIndex] !== undefined) {
                data[i].signal = signalEma[signalIndex].toFixed(2);
                data[i].histogram = (data[i].macd - data[i].signal).toFixed(2);
            } else {
                data[i].signal = null;
                data[i].histogram = null;
            }
            signalIndex++;
        } else {
            data[i].signal = null;
            data[i].histogram = null;
        }
    }
}

function aggregateData(sourceData, period) {
    if (period === 'day') return sourceData;
    
    const getPeriodKey = (dateStr) => {
        const d = new Date(dateStr);
        if (period === 'week') {
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff)).toISOString().split('T')[0];
        }
        if (period === 'month') {
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`;
        }
    };
    
    const groupedData = sourceData.reduce((acc, curr) => {
        const key = getPeriodKey(curr.date);
        if (!acc[key]) acc[key] = [];
        acc[key].push(curr);
        return acc;
    }, {});
    
    return Object.keys(groupedData).map(key => {
        const group = groupedData[key];
        const first = group[0];
        const last = group[group.length - 1];
        return {
            date: key,
            open: first.open,
            high: Math.max(...group.map(d => d.high)),
            low: Math.min(...group.map(d => d.low)),
            close: last.close,
            volume: group.reduce((sum, d) => sum + d.volume, 0),
            rocDate: last.rocDate,
            stockCode: first.stockCode,
            stockName: first.stockName
        };
    });
}

// ============================================
// åœ–è¡¨æ¸²æŸ“
// ============================================
function updateCharts(period) {
    if (!originalStockData || originalStockData.length === 0) return;
    
    let dataToProcess;
    const freshData = JSON.parse(JSON.stringify(originalStockData));
    
    if (period === 'day') {
        dataToProcess = freshData;
    } else {
        dataToProcess = aggregateData(freshData, period);
    }
    
    processStockData(dataToProcess);
    renderAllCharts(dataToProcess);
}

function renderAllCharts(data) {
    const theme = {
        chart: { foreColor: '#a0a0b0', background: 'transparent' },
        tooltip: { theme: 'dark' },
        xaxis: { labels: { style: { colors: '#a0a0b0' } } },
        yaxis: { labels: { style: { colors: '#a0a0b0' } } },
        grid: { borderColor: '#2d3a5a' }
    };
    
    // Main Chart (Candlestick + Bollinger)
    const seriesMain = [
        { name: 'è‚¡åƒ¹', type: 'candlestick', data: data.map(d => ({ x: new Date(d.date).getTime(), y: [d.open, d.high, d.low, d.close] })) },
        { name: 'BBä¸Šè»Œ', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.bb_upper })) },
        { name: 'MA20', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.ma20 })) },
        { name: 'BBä¸‹è»Œ', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.bb_lower })) }
    ];
    renderChart('main-chart', createChartOptions('main-chart', seriesMain, 'candlestick', [], theme, data));
    
    // MACD
    const seriesMacd = [
        { name: 'DIF', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.macd })) },
        { name: 'MACD', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.signal })) },
        { name: 'OSC', type: 'bar', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.histogram })) }
    ];
    renderChart('macd-chart', createChartOptions('macd-chart', seriesMacd, 'line', [], theme, data));
    
    // KD
    const seriesKD = [
        { name: 'Kå€¼', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.k })) },
        { name: 'Då€¼', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.d })) }
    ];
    renderChart('kd-chart', createChartOptions('kd-chart', seriesKD, 'line', [20, 80], theme, data));
    
    // RSI
    const seriesRSI = [{ name: 'RSI', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.rsi })) }];
    renderChart('rsi-chart', createChartOptions('rsi-chart', seriesRSI, 'line', [30, 70], theme, data));
    
    // MFI
    const seriesMFI = [{ name: 'MFI', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.mfi })) }];
    renderChart('mfi-chart', createChartOptions('mfi-chart', seriesMFI, 'line', [20, 80], theme, data));
    
    // BIAS
    const seriesBias = [{ name: 'BIAS', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.bias })) }];
    renderChart('bias-chart', createChartOptions('bias-chart', seriesBias, 'line', [], theme, data));
    
    // Williams %R
    const seriesWR = [{ name: '%R', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.williamsR })) }];
    renderChart('wr-chart', createChartOptions('wr-chart', seriesWR, 'line', [-80, -20], theme, data));
}

function renderChart(chartId, options) {
    if (charts[chartId]) {
        charts[chartId].destroy();
    }
    const chartEl = document.querySelector(`#${chartId}`);
    if (chartEl) {
        const chart = new ApexCharts(chartEl, options);
        chart.render();
        charts[chartId] = chart;
    }
}

function createChartOptions(chartId, series, type, yAxisLines = [], theme = {}, data = []) {
    const colorRise = '#e74c3c';
    const colorFall = '#27ae60';
    
    let annotations = {
        yaxis: yAxisLines.map((val, index) => ({
            y: val,
            borderColor: index === 0 ? colorFall : colorRise,
            label: {
                borderColor: index === 0 ? colorFall : colorRise,
                style: { color: '#fff', background: index === 0 ? colorFall : colorRise },
                text: String(val)
            }
        }))
    };
    
    return {
        ...theme,
        series: series,
        annotations: annotations,
        chart: {
            ...theme.chart,
            type: type === 'candlestick' ? 'candlestick' : 'line',
            height: 280,
            toolbar: { show: false },
            zoom: { enabled: true }
        },
        xaxis: {
            ...theme.xaxis,
            type: 'datetime',
            labels: { datetimeUTC: false }
        },
        yaxis: {
            ...theme.yaxis,
            opposite: true,
            labels: {
                formatter: (value) => {
                    if (value === null || typeof value === 'undefined') return '';
                    return typeof value === 'number' ? value.toFixed(2) : value;
                }
            }
        },
        tooltip: {
            ...theme.tooltip,
            shared: true,
            x: { format: 'yyyy/MM/dd' }
        },
        plotOptions: {
            candlestick: {
                colors: { upward: colorRise, downward: colorFall }
            },
            bar: {
                colors: {
                    ranges: [
                        { from: -Infinity, to: -0.0001, color: colorFall },
                        { from: 0, to: Infinity, color: colorRise }
                    ]
                }
            }
        },
        stroke: { curve: 'straight', width: 2 },
        legend: { labels: { colors: '#a0a0b0' } }
    };
}

// ============================================
// å„²å­˜åŠŸèƒ½
// ============================================
function saveDataToStorage() {
    try {
        localStorage.setItem('stockData', JSON.stringify(originalStockData));
    } catch (e) {
        console.error('å„²å­˜è³‡æ–™å¤±æ•—:', e);
    }
}

function loadStoredData() {
    try {
        const stored = localStorage.getItem('stockData');
        if (stored) {
            originalStockData = JSON.parse(stored);
        }
    } catch (e) {
        console.error('è®€å–è³‡æ–™å¤±æ•—:', e);
        originalStockData = [];
    }
}

function loadApiKey() {
    const stored = localStorage.getItem('geminiApiKey');
    if (stored) {
        userApiKey = stored;
        document.getElementById('apiKeyInput').value = stored;
        document.getElementById('apiKeyStatus').innerHTML = '<div class="status-msg success">âœ… å·²è¼‰å…¥å„²å­˜çš„ API Key</div>';
    }
}

// ============================================
// API Key é©—è­‰
// ============================================
document.getElementById('validateApiKeyBtn').addEventListener('click', async function() {
    const key = document.getElementById('apiKeyInput').value.trim();
    const status = document.getElementById('apiKeyStatus');
    
    if (!key) {
        status.innerHTML = '<div class="status-msg error">è«‹è¼¸å…¥ API Key</div>';
        return;
    }
    
    status.innerHTML = '<div class="status-msg info">æ­£åœ¨é©—è­‰...</div>';
    
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
        if (response.ok) {
            userApiKey = key;
            localStorage.setItem('geminiApiKey', key);
            status.innerHTML = '<div class="status-msg success">âœ… é©—è­‰æˆåŠŸï¼</div>';
            showToast('API Key å·²å„²å­˜');
        } else {
            status.innerHTML = '<div class="status-msg error">âŒ é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key</div>';
        }
    } catch (error) {
        status.innerHTML = '<div class="status-msg error">âŒ é©—è­‰å¤±æ•—ï¼š' + error.message + '</div>';
    }
});

// ============================================
// AI åˆ†æåŠŸèƒ½
// ============================================
async function callGeminiApi(prompt) {
    if (!userApiKey) throw new Error('è«‹å…ˆè¨­å®š API Key');
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
        })
    });
    
    if (!response.ok) throw new Error('API è«‹æ±‚å¤±æ•—');
    
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

async function callGroundedGeminiApi(prompt) {
    if (!userApiKey) throw new Error('è«‹å…ˆè¨­å®š API Key');
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            tools: [{ googleSearchRetrieval: { dynamicRetrievalConfig: { mode: "MODE_DYNAMIC", dynamicThreshold: 0.3 } } }]
        })
    });
    
    if (!response.ok) throw new Error('API è«‹æ±‚å¤±æ•—');
    
    const data = await response.json();
    const text = data.candidates[0].content.parts[0].text;
    
    let sources = [];
    if (data.candidates[0].groundingMetadata && data.candidates[0].groundingMetadata.groundingChunks) {
        sources = data.candidates[0].groundingMetadata.groundingChunks
            .filter(c => c.web)
            .map(c => ({ uri: c.web.uri, title: c.web.title }));
    }
    
    return { text, sources };
}

function generatePrompt(analysisType, data) {
    const stockName = data[0]?.stockName || 'æœªçŸ¥';
    const stockCode = data[0]?.stockCode || 'æœªçŸ¥';
    const dataStr = data.map(d => `æ—¥æœŸ:${d.date},é–‹:${d.open},é«˜:${d.high},ä½:${d.low},æ”¶:${d.close},é‡:${d.volume}`).join('\n');
    
    const prompts = {
        summary: `ä½ æ˜¯å°ˆæ¥­çš„è‚¡ç¥¨åˆ†æå¸«ã€‚è«‹é‡å°ã€Œ${stockName}(${stockCode})ã€çš„ä»¥ä¸‹äº¤æ˜“è³‡æ–™ï¼Œæä¾›ç¸½é«”æ‘˜è¦åˆ†æï¼š\n${dataStr}`,
        technical: `ä½ æ˜¯æŠ€è¡“åˆ†æå°ˆå®¶ã€‚è«‹é‡å°ã€Œ${stockName}(${stockCode})ã€çš„ä»¥ä¸‹è³‡æ–™ï¼Œé€²è¡ŒæŠ€è¡“æŒ‡æ¨™åˆ†æï¼ˆåŒ…å« MAã€KDã€RSIã€MACD ç­‰ï¼‰ï¼š\n${dataStr}`,
        fundamental: `ä½ æ˜¯åŸºæœ¬é¢åˆ†æå¸«ã€‚è«‹é‡å°ã€Œ${stockName}(${stockCode})ã€ï¼Œçµåˆå…¶ç”¢æ¥­åœ°ä½èˆ‡æœ€è¿‘è‚¡åƒ¹è¡¨ç¾ï¼Œæä¾›åŸºæœ¬é¢è§£è®€ï¼š\n${dataStr}`,
        news: `ä½ æ˜¯å¸‚å ´æƒ…ç·’åˆ†æå¸«ã€‚è«‹é‡å°ã€Œ${stockName}(${stockCode})ã€ï¼Œåˆ†æå¯èƒ½å½±éŸ¿è‚¡åƒ¹çš„å¸‚å ´æ–°èèˆ‡æƒ…ç·’å› ç´ ï¼š\n${dataStr}`,
        future: `ä½ æ˜¯è¶¨å‹¢é æ¸¬å°ˆå®¶ã€‚è«‹é‡å°ã€Œ${stockName}(${stockCode})ã€çš„ä»¥ä¸‹è³‡æ–™ï¼Œé æ¸¬æœªä¾†å¯èƒ½çš„èµ°å‹¢ï¼š\n${dataStr}`
    };
    
    return prompts[analysisType] || prompts.summary;
}

// AI æ™ºæ…§åˆ†æ
document.getElementById('analyzeBtn').addEventListener('click', async function() {
    if (!userApiKey) {
        showToast('è«‹å…ˆè¨­å®š API Key');
        return;
    }
    if (originalStockData.length === 0) {
        showToast('è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™');
        return;
    }
    
    const loader = document.getElementById('aiSmartLoader');
    const result = document.getElementById('aiSmartResult');
    const resultText = document.getElementById('aiResultText');
    
    loader.classList.add('show');
    result.style.display = 'none';
    
    try {
        const analysisType = document.getElementById('analysisType').value;
        const recentData = originalStockData.slice(-30);
        const prompt = generatePrompt(analysisType, recentData);
        
        const text = await callGeminiApi(prompt);
        resultText.textContent = text;
        result.style.display = 'block';
        document.getElementById('ttsBtn').style.display = 'inline-block';
        document.getElementById('downloadAiMd').style.display = 'inline-block';
        
    } catch (error) {
        resultText.textContent = 'åˆ†æå¤±æ•—ï¼š' + error.message;
        result.style.display = 'block';
    } finally {
        loader.classList.remove('show');
    }
});

// AI å°ˆå®¶å»ºè­°
document.getElementById('expertAdviceBtn').addEventListener('click', async function() {
    if (!userApiKey) {
        showToast('è«‹å…ˆè¨­å®š API Key');
        return;
    }
    if (originalStockData.length === 0) {
        showToast('è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™');
        return;
    }
    
    const loader = document.getElementById('expertLoader');
    const result = document.getElementById('expertResult');
    const resultText = document.getElementById('expertResultText');
    
    loader.classList.add('show');
    result.style.display = 'none';
    
    try {
        const recentData = originalStockData.slice(-30);
        const stockName = recentData[0]?.stockName || 'æœªçŸ¥';
        const stockCode = recentData[0]?.stockCode || 'æœªçŸ¥';
        const dataStr = recentData.map(d => `${d.date},${d.open},${d.high},${d.low},${d.close},${d.volume}`).join('\n');
        
        const prompt = `ä½ æ˜¯ä¸€ä½è³‡æ·±çš„æŠ•è³‡åˆ†æå¸«ã€‚è«‹æ ¹æ“šã€Œ${stockName}(${stockCode})ã€çš„ä»¥ä¸‹ 30 å¤©äº¤æ˜“è³‡æ–™ï¼Œæä¾›å°ˆæ¥­çš„æŠ•è³‡å»ºè­°å ±å‘Šã€‚
å ±å‘Šæ‡‰åŒ…å«ï¼š
1. æŠ€è¡“é¢åˆ†æï¼ˆè¶¨å‹¢ã€æ”¯æ’å£“åŠ›ã€æŒ‡æ¨™è¨Šè™Ÿï¼‰
2. é¢¨éšªè©•ä¼°
3. æ“ä½œå»ºè­°ï¼ˆè²·å…¥/è³£å‡º/è§€æœ›ï¼‰
4. ç›®æ¨™åƒ¹ä½èˆ‡åœæé»
5. ç¸½çµ

è³‡æ–™æ ¼å¼ï¼šæ—¥æœŸ,é–‹,é«˜,ä½,æ”¶,é‡
${dataStr}`;
        
        const text = await callGeminiApi(prompt);
        resultText.textContent = text;
        result.style.display = 'block';
        
    } catch (error) {
        resultText.textContent = 'åˆ†æå¤±æ•—ï¼š' + error.message;
        result.style.display = 'block';
    } finally {
        loader.classList.remove('show');
    }
});

// AI å‹æ…‹è¾¨è­˜
document.getElementById('patternBtn').addEventListener('click', async function() {
    if (!userApiKey) {
        showToast('è«‹å…ˆè¨­å®š API Key');
        return;
    }
    if (originalStockData.length === 0) {
        showToast('è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™');
        return;
    }
    
    const loader = document.getElementById('patternLoader');
    const result = document.getElementById('patternResult');
    const resultText = document.getElementById('patternResultText');
    
    loader.classList.add('show');
    result.style.display = 'none';
    
    try {
        const recentData = originalStockData.slice(-60);
        const stockName = recentData[0]?.stockName || 'æœªçŸ¥';
        const stockCode = recentData[0]?.stockCode || 'æœªçŸ¥';
        const dataStr = recentData.map(d => `${d.date},${d.open},${d.high},${d.low},${d.close}`).join('\n');
        
        const prompt = `ä½ æ˜¯ K ç·šå‹æ…‹è¾¨è­˜å°ˆå®¶ã€‚è«‹åˆ†æã€Œ${stockName}(${stockCode})ã€çš„ä»¥ä¸‹ K ç·šè³‡æ–™ï¼Œè¾¨è­˜å…¶ä¸­çš„å‹æ…‹ï¼š
1. è¾¨è­˜å‡ºç¾çš„ K ç·šå‹æ…‹ï¼ˆå¦‚ï¼šåå­—æ˜Ÿã€éŒ˜å­ç·šã€åå™¬å‹æ…‹ã€é ­è‚©åº•ç­‰ï¼‰
2. èªªæ˜å„å‹æ…‹çš„æ„ç¾©
3. æ ¹æ“šå‹æ…‹çµ¦å‡ºæ“ä½œå»ºè­°

è³‡æ–™æ ¼å¼ï¼šæ—¥æœŸ,é–‹,é«˜,ä½,æ”¶
${dataStr}`;
        
        const text = await callGeminiApi(prompt);
        resultText.textContent = text;
        result.style.display = 'block';
        
    } catch (error) {
        resultText.textContent = 'åˆ†æå¤±æ•—ï¼š' + error.message;
        result.style.display = 'block';
    } finally {
        loader.classList.remove('show');
    }
});

// AI è²¡å ±åˆ†æ
document.getElementById('financialBtn').addEventListener('click', async function() {
    if (!userApiKey) {
        showToast('è«‹å…ˆè¨­å®š API Key');
        return;
    }
    
    const text = document.getElementById('financialTextInput').value.trim();
    if (!text) {
        showToast('è«‹è²¼ä¸Šè²¡å ±å…§å®¹');
        return;
    }
    
    const loader = document.getElementById('financialLoader');
    const result = document.getElementById('financialResult');
    const resultText = document.getElementById('financialResultText');
    
    loader.classList.add('show');
    result.style.display = 'none';
    
    try {
        const prompt = `ä½ æ˜¯è²¡å‹™åˆ†æå¸«ã€‚è«‹åˆ†æä»¥ä¸‹è²¡å ±/æ³•èªªæœƒå…§å®¹ï¼š
1. å…§å®¹æ‘˜è¦ï¼ˆ2-3 é»ï¼‰
2. æ­£é¢è§£è®€ï¼ˆProsï¼‰
3. è² é¢è§£è®€ï¼ˆConsï¼‰
4. ç¶œåˆè©•è«–èˆ‡å±•æœ›

---
${text}`;
        
        const response = await callGeminiApi(prompt);
        resultText.textContent = response;
        result.style.display = 'block';
        
    } catch (error) {
        resultText.textContent = 'åˆ†æå¤±æ•—ï¼š' + error.message;
        result.style.display = 'block';
    } finally {
        loader.classList.remove('show');
    }
});

// ç¶²è·¯å•ç­”
document.getElementById('qaBtn').addEventListener('click', async function() {
    if (!userApiKey) {
        showToast('è«‹å…ˆè¨­å®š API Key');
        return;
    }
    if (originalStockData.length === 0) {
        showToast('è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™');
        return;
    }
    
    const question = document.getElementById('qaInput').value.trim();
    if (!question) {
        showToast('è«‹è¼¸å…¥å•é¡Œ');
        return;
    }
    
    const loader = document.getElementById('qaLoader');
    const result = document.getElementById('qaResult');
    const resultText = document.getElementById('qaResultText');
    const citations = document.getElementById('qaCitations');
    
    loader.classList.add('show');
    result.style.display = 'none';
    
    try {
        const stockName = originalStockData[0]?.stockName || '';
        const stockCode = originalStockData[0]?.stockCode || '';
        const prompt = `è«‹å›ç­”é—œæ–¼å°ç£ä¸Šå¸‚å…¬å¸ã€Œ${stockName} (${stockCode})ã€çš„å•é¡Œï¼š${question}`;
        
        const response = await callGroundedGeminiApi(prompt);
        resultText.textContent = response.text;
        
        if (response.sources && response.sources.length > 0) {
            citations.innerHTML = '<h4>åƒè€ƒä¾†æºï¼š</h4>' + response.sources.map(s => 
                `<a href="${s.uri}" target="_blank">${s.title}</a>`
            ).join('');
        } else {
            citations.innerHTML = '';
        }
        
        result.style.display = 'block';
        
    } catch (error) {
        resultText.textContent = 'æŸ¥è©¢å¤±æ•—ï¼š' + error.message;
        result.style.display = 'block';
    } finally {
        loader.classList.remove('show');
    }
});

// å€‹è‚¡æ¦‚æ³
document.getElementById('overviewBtn').addEventListener('click', async function() {
    if (!userApiKey) {
        showToast('è«‹å…ˆè¨­å®š API Key');
        return;
    }
    if (originalStockData.length === 0) {
        showToast('è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™');
        return;
    }
    
    const loader = document.getElementById('overviewLoader');
    const result = document.getElementById('overviewResult');
    const resultText = document.getElementById('overviewResultText');
    
    loader.classList.add('show');
    result.style.display = 'none';
    
    try {
        const stockName = originalStockData[0]?.stockName || '';
        const stockCode = originalStockData[0]?.stockCode || '';
        
        const prompt = `è«‹æä¾›å°ç£ä¸Šå¸‚å…¬å¸ã€Œ${stockName} (${stockCode})ã€çš„æ¦‚æ³åˆ†æï¼ŒåŒ…å«ï¼š
1. å…¬å¸ç°¡ä»‹èˆ‡ä¸»è¦æ¥­å‹™
2. ç”¢æ¥­åœ°ä½èˆ‡ç«¶çˆ­å„ªå‹¢
3. è¿‘æœŸç‡Ÿæ”¶è¡¨ç¾
4. ä¸»è¦ç”¢å“/æœå‹™
5. æœªä¾†å±•æœ›`;
        
        const response = await callGroundedGeminiApi(prompt);
        resultText.textContent = response.text;
        result.style.display = 'block';
        
    } catch (error) {
        resultText.textContent = 'åˆ†æå¤±æ•—ï¼š' + error.message;
        result.style.display = 'block';
    } finally {
        loader.classList.remove('show');
    }
});

// å·æ™®ä¸€å¥è©±
document.getElementById('trumpBtn').addEventListener('click', async function() {
    if (!userApiKey) {
        showToast('è«‹å…ˆè¨­å®š API Key');
        return;
    }
    
    const loader = document.getElementById('trumpLoader');
    const result = document.getElementById('trumpResult');
    const resultText = document.getElementById('trumpResultText');
    
    loader.classList.add('show');
    result.style.display = 'none';
    
    try {
        let quote = document.getElementById('trumpQuoteInput').value.trim();
        let prompt;
        
        if (quote) {
            prompt = `åˆ†æå·æ™®çš„ä»¥ä¸‹è¨€è«–å°è‚¡å¸‚çš„æ½›åœ¨å½±éŸ¿ï¼š
ã€Œ${quote}ã€

è«‹åˆ†æï¼š
1. è¨€è«–çš„èƒŒæ™¯èˆ‡æ„åœ–
2. å¯èƒ½å½±éŸ¿çš„ç”¢æ¥­/è‚¡ç¥¨
3. å°å°è‚¡çš„æ½›åœ¨å½±éŸ¿
4. æŠ•è³‡å»ºè­°`;
        } else {
            prompt = `è«‹æœå°‹å·æ™®æœ€è¿‘çš„é‡è¦è¨€è«–ï¼Œä¸¦åˆ†æå…¶å°è‚¡å¸‚çš„å½±éŸ¿ï¼š
1. æ‰¾å‡ºæœ€è¿‘é‡è¦çš„å·æ™®è¨€è«–
2. åˆ†æå¯èƒ½å½±éŸ¿çš„ç”¢æ¥­
3. å°å°è‚¡çš„æ½›åœ¨å½±éŸ¿
4. æŠ•è³‡å»ºè­°`;
        }
        
        const response = await callGroundedGeminiApi(prompt);
        resultText.textContent = response.text;
        result.style.display = 'block';
        
    } catch (error) {
        resultText.textContent = 'åˆ†æå¤±æ•—ï¼š' + error.message;
        result.style.display = 'block';
    } finally {
        loader.classList.remove('show');
    }
});

// ç¾è‚¡åˆ†æ
document.getElementById('usMarketBtn').addEventListener('click', async function() {
    if (!userApiKey) {
        showToast('è«‹å…ˆè¨­å®š API Key');
        return;
    }
    
    const loader = document.getElementById('usMarketLoader');
    const result = document.getElementById('usMarketResult');
    const resultText = document.getElementById('usMarketResultText');
    
    loader.classList.add('show');
    result.style.display = 'none';
    
    try {
        const prompt = `è«‹æä¾›æœ€æ–°çš„ç¾è‚¡ç›¤å¾Œåˆ†æå ±å‘Šï¼ŒåŒ…å«ï¼š
1. ä¸‰å¤§æŒ‡æ•¸è¡¨ç¾ï¼ˆé“ç“Šã€æ¨™æ™®500ã€é‚£æ–¯é”å…‹ï¼‰
2. é‡è¦å€‹è‚¡è¡¨ç¾ï¼ˆè˜‹æœã€è¼é”ã€å°ç©é›»ADRç­‰ï¼‰
3. å¸‚å ´ç„¦é»èˆ‡æ–°è
4. å°æ˜æ—¥å°è‚¡çš„å½±éŸ¿é æ¸¬
5. æ“ä½œå»ºè­°`;
        
        const response = await callGroundedGeminiApi(prompt);
        resultText.textContent = response.text;
        result.style.display = 'block';
        
    } catch (error) {
        resultText.textContent = 'åˆ†æå¤±æ•—ï¼š' + error.message;
        result.style.display = 'block';
    } finally {
        loader.classList.remove('show');
    }
});

// ============================================
// å·¥å…·åŠŸèƒ½
// ============================================

// å€‹è‚¡ PK
document.getElementById('pkCompareBtn').addEventListener('click', async function() {
    const codes = [
        document.getElementById('pkCode1').value.trim(),
        document.getElementById('pkCode2').value.trim(),
        document.getElementById('pkCode3').value.trim(),
        document.getElementById('pkCode4').value.trim()
    ].filter(c => c);
    
    if (codes.length < 2) {
        showToast('è«‹è‡³å°‘è¼¸å…¥ 2 å€‹è‚¡ç¥¨ä»£è™Ÿ');
        return;
    }
    
    const startDate = document.getElementById('pkStartDate').value;
    const endDate = document.getElementById('pkEndDate').value;
    
    if (!startDate || !endDate) {
        showToast('è«‹é¸æ“‡æ—¥æœŸç¯„åœ');
        return;
    }
    
    const loader = document.getElementById('pkLoader');
    const status = document.getElementById('pkStatus');
    const chartContainer = document.getElementById('pkChartContainer');
    
    loader.classList.add('show');
    chartContainer.style.display = 'none';
    status.innerHTML = '<div class="status-msg info">æ­£åœ¨æŠ“å–è³‡æ–™...</div>';
    
    try {
        const dataPromises = codes.map(code => fetchStockData(code, startDate, endDate));
        const allData = await Promise.all(dataPromises);
        
        const series = allData.map((stockData, index) => {
            const code = codes[index];
            const stockName = stockData[0]?.stockName || code;
            return {
                name: `${stockName} (${code})`,
                data: stockData.map(d => [new Date(d.date).getTime(), d.close])
            };
        });
        
        status.innerHTML = '';
        chartContainer.style.display = 'block';
        
        if (charts['pk-chart']) charts['pk-chart'].destroy();
        
        const chart = new ApexCharts(document.getElementById('pk-chart'), {
            series: series,
            chart: {
                type: 'line',
                height: 300,
                foreColor: '#a0a0b0',
                background: 'transparent',
                toolbar: { show: false }
            },
            stroke: { curve: 'straight', width: 2 },
            xaxis: { type: 'datetime' },
            tooltip: { theme: 'dark', x: { format: 'yyyy/MM/dd' } },
            grid: { borderColor: '#2d3a5a' },
            legend: { labels: { colors: '#a0a0b0' } }
        });
        chart.render();
        charts['pk-chart'] = chart;
        
    } catch (error) {
        status.innerHTML = `<div class="status-msg error">âŒ ${error.message}</div>`;
    } finally {
        loader.classList.remove('show');
    }
});

// ç­–ç•¥å›æ¸¬
document.getElementById('backtestBtn').addEventListener('click', function() {
    if (!originalStockData || originalStockData.length < 20) {
        showToast('è«‹å…ˆè¼‰å…¥è‡³å°‘ 20 å¤©çš„è³‡æ–™');
        return;
    }
    
    const loader = document.getElementById('backtestLoader');
    const result = document.getElementById('backtestResult');
    
    loader.classList.add('show');
    result.style.display = 'none';
    
    setTimeout(() => {
        const data = JSON.parse(JSON.stringify(originalStockData));
        processStockData(data);
        
        const initialCapital = parseFloat(document.getElementById('initialCapital').value) || 1000000;
        let cash = initialCapital;
        let shares = 0;
        let inPosition = false;
        const trades = [];
        let currentTrade = {};
        const portfolioHistory = [];
        
        for (let i = 20; i < data.length; i++) {
            const current = data[i];
            const prev = data[i-1];
            
            const currentMA5 = parseFloat(current.ma5);
            const currentMA20 = parseFloat(current.ma20);
            const prevMA5 = parseFloat(prev.ma5);
            const prevMA20 = parseFloat(prev.ma20);
            
            // é»ƒé‡‘äº¤å‰è²·å…¥
            if (!inPosition && prevMA5 <= prevMA20 && currentMA5 > currentMA20) {
                const buyPrice = current.close;
                shares = Math.floor(cash / buyPrice);
                cash -= shares * buyPrice;
                inPosition = true;
                currentTrade = { buyDate: current.date, buyPrice: buyPrice };
            }
            // æ­»äº¡äº¤å‰è³£å‡º
            else if (inPosition && prevMA5 >= prevMA20 && currentMA5 < currentMA20) {
                const sellPrice = current.close;
                cash += shares * sellPrice;
                shares = 0;
                inPosition = false;
                currentTrade.sellDate = current.date;
                currentTrade.sellPrice = sellPrice;
                currentTrade.profit = ((sellPrice - currentTrade.buyPrice) / currentTrade.buyPrice * 100).toFixed(2);
                trades.push(currentTrade);
                currentTrade = {};
            }
            
            portfolioHistory.push({
                x: new Date(current.date).getTime(),
                y: cash + (shares * current.close)
            });
        }
        
        // å¦‚æœé‚„æœ‰æŒè‚¡
        if (inPosition) {
            const lastDay = data[data.length - 1];
            const sellPrice = lastDay.close;
            cash += shares * sellPrice;
            currentTrade.sellDate = lastDay.date;
            currentTrade.sellPrice = sellPrice;
            currentTrade.profit = ((sellPrice - currentTrade.buyPrice) / currentTrade.buyPrice * 100).toFixed(2);
            trades.push(currentTrade);
        }
        
        // é¡¯ç¤ºçµæœ
        const finalValue = portfolioHistory.length > 0 ? portfolioHistory[portfolioHistory.length - 1].y : initialCapital;
        const totalReturn = ((finalValue - initialCapital) / initialCapital * 100).toFixed(2);
        const winningTrades = trades.filter(t => t.profit > 0).length;
        const winRate = trades.length > 0 ? (winningTrades / trades.length * 100).toFixed(2) : 0;
        
        document.getElementById('backtestSummary').innerHTML = `
            <div class="summary-card">
                <div class="label">æœ€çµ‚è³‡ç”¢</div>
                <div class="value">${Math.round(finalValue).toLocaleString()}</div>
            </div>
            <div class="summary-card">
                <div class="label">ç¸½å ±é…¬ç‡</div>
                <div class="value ${totalReturn >= 0 ? 'text-rise' : 'text-fall'}">${totalReturn}%</div>
            </div>
            <div class="summary-card">
                <div class="label">äº¤æ˜“æ¬¡æ•¸</div>
                <div class="value">${trades.length}</div>
            </div>
            <div class="summary-card">
                <div class="label">å‹ç‡</div>
                <div class="value">${winRate}%</div>
            </div>
        `;
        
        document.getElementById('backtestTradesBody').innerHTML = trades.map(t => `
            <tr>
                <td>${t.buyDate}</td>
                <td>${t.buyPrice}</td>
                <td>${t.sellDate}</td>
                <td>${t.sellPrice}</td>
                <td class="${t.profit >= 0 ? 'text-rise' : 'text-fall'}">${t.profit}%</td>
            </tr>
        `).join('');
        
        // ç¹ªè£½åœ–è¡¨
        if (charts['backtest-chart']) charts['backtest-chart'].destroy();
        
        // è²·å…¥æŒæœ‰ç­–ç•¥
        const buyAndHoldShares = Math.floor(initialCapital / data[19].close);
        const buyAndHoldHistory = data.slice(19).map(d => ({
            x: new Date(d.date).getTime(),
            y: (buyAndHoldShares * d.close) + (initialCapital - buyAndHoldShares * data[19].close)
        }));
        
        const chart = new ApexCharts(document.getElementById('backtest-chart'), {
            series: [
                { name: 'ç­–ç•¥å ±é…¬', data: portfolioHistory },
                { name: 'è²·å…¥æŒæœ‰', data: buyAndHoldHistory }
            ],
            chart: {
                type: 'line',
                height: 250,
                foreColor: '#a0a0b0',
                background: 'transparent',
                toolbar: { show: false }
            },
            stroke: { curve: 'straight', width: 2 },
            xaxis: { type: 'datetime' },
            yaxis: {
                labels: {
                    formatter: (val) => Math.round(val).toLocaleString()
                }
            },
            tooltip: { theme: 'dark', x: { format: 'yyyy/MM/dd' } },
            grid: { borderColor: '#2d3a5a' },
            legend: { labels: { colors: '#a0a0b0' } }
        });
        chart.render();
        charts['backtest-chart'] = chart;
        
        loader.classList.remove('show');
        result.style.display = 'block';
    }, 100);
});

// æœˆåº¦æŸ¥è©¢
document.getElementById('monthlyQueryBtn').addEventListener('click', async function() {
    const stockCode = document.getElementById('monthlyStockCode').value.trim();
    const year = document.getElementById('queryYear').value;
    const month = document.getElementById('queryMonth').value.padStart(2, '0');
    
    if (!stockCode) {
        showToast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
        return;
    }
    
    const loader = document.getElementById('monthlyLoader');
    const status = document.getElementById('monthlyQueryStatus');
    const container = document.getElementById('monthlyDataContainer');
    
    loader.classList.add('show');
    container.style.display = 'none';
    status.innerHTML = '';
    
    try {
        const monthStr = `${year}${month}`;
        const result = await fetchDataForMonth(stockCode, monthStr);
        
        if (result.stat === 'OK' && result.data && result.data.length > 0) {
            document.getElementById('monthlyDataBody').innerHTML = result.data.map(item => {
                const rocDate = item[0].trim();
                const [rocYear, m, d] = rocDate.split('/');
                const dateStr = `${parseInt(rocYear) + 1911}-${m}-${d}`;
                const close = parseFloat(String(item[6]).replace(/,/g, ''));
                const change = String(item[7]).replace(/,/g, '');
                const changeValue = parseFloat(change);
                
                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${item[3]}</td>
                        <td>${item[4]}</td>
                        <td>${item[5]}</td>
                        <td class="${changeValue > 0 ? 'text-rise' : changeValue < 0 ? 'text-fall' : ''}">${item[6]}</td>
                        <td class="${changeValue > 0 ? 'text-rise' : changeValue < 0 ? 'text-fall' : ''}">${changeValue > 0 ? '+' : ''}${change}</td>
                    </tr>
                `;
            }).join('');
            container.style.display = 'block';
        } else {
            status.innerHTML = '<div class="status-msg error">æŸ¥ç„¡è³‡æ–™</div>';
        }
    } catch (error) {
        status.innerHTML = `<div class="status-msg error">${error.message}</div>`;
    } finally {
        loader.classList.remove('show');
    }
});

// ============================================
// åŒ¯å‡ºåŠŸèƒ½
// ============================================
document.getElementById('exportCsvBtn').addEventListener('click', exportData);
document.getElementById('exportAllDataBtn').addEventListener('click', exportData);

function exportData() {
    if (!originalStockData || originalStockData.length === 0) {
        showToast('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
        return;
    }
    
    const data = originalStockData;
    const stockCode = data[0].stockCode || 'STOCK';
    const stockName = data[0].stockName || '';
    
    const header = '"æ—¥æœŸ","æˆäº¤è‚¡æ•¸","æˆäº¤é‡‘é¡","é–‹ç›¤åƒ¹","æœ€é«˜åƒ¹","æœ€ä½åƒ¹","æ”¶ç›¤åƒ¹","æ¼²è·Œåƒ¹å·®","æˆäº¤ç­†æ•¸"';
    const rows = data.map(d => {
        return [d.rocDate, d.volume, d.amount, d.open, d.high, d.low, d.close, d.change, d.transactions]
            .map(v => `"${v}"`).join(',');
    });
    
    const csvContent = [header, ...rows].join('\n');
    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${stockCode}_${stockName}.csv`;
    link.click();
    
    showToast('CSV åŒ¯å‡ºæˆåŠŸï¼');
}

// æ¸…é™¤è³‡æ–™
document.getElementById('clearDataBtn').addEventListener('click', function() {
    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
        localStorage.removeItem('stockData');
        originalStockData = [];
        
        document.getElementById('displayStockName').textContent = 'å°šæœªè¼‰å…¥è‚¡ç¥¨';
        document.getElementById('displayStockCode').textContent = 'è«‹å…ˆæŸ¥è©¢æˆ–é¸æ“‡è‚¡ç¥¨';
        document.getElementById('displayPrice').textContent = '--';
        document.getElementById('displayChange').textContent = '--';
        document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center;">è«‹å…ˆè¼‰å…¥è³‡æ–™</td></tr>';
        
        // æ¸…é™¤åœ–è¡¨
        Object.keys(charts).forEach(key => {
            if (charts[key]) {
                charts[key].destroy();
                charts[key] = null;
            }
        });
        
        showToast('è³‡æ–™å·²æ¸…é™¤');
    }
});

// TTS æ’­æ”¾
document.getElementById('ttsBtn').addEventListener('click', function() {
    const text = document.getElementById('aiResultText').textContent;
    if (text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        speechSynthesis.speak(utterance);
        showToast('é–‹å§‹æ’­æ”¾...');
    }
});

// PDF ä¸‹è¼‰
document.getElementById('downloadPdfBtn').addEventListener('click', async function() {
    const text = document.getElementById('expertResultText').textContent;
    if (!text) {
        showToast('è«‹å…ˆç”Ÿæˆå°ˆå®¶å»ºè­°');
        return;
    }
    
    showToast('æ­£åœ¨ç”Ÿæˆ PDF...');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
    
    const stockName = originalStockData[0]?.stockName || '';
    const stockCode = originalStockData[0]?.stockCode || '';
    
    const container = document.createElement('div');
    container.innerHTML = `<h2>${stockName} (${stockCode}) AI å°ˆå®¶åˆ†æå ±å‘Š</h2><pre style="white-space: pre-wrap;">${text}</pre>`;
    container.style.cssText = 'width: 180mm; padding: 10px; color: black; background: white; position: absolute; left: -9999px; font-family: sans-serif;';
    document.body.appendChild(container);
    
    try {
        const canvas = await html2canvas(container, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 190;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        doc.save(`${stockCode}_AI_Report.pdf`);
        showToast('PDF ä¸‹è¼‰å®Œæˆï¼');
    } catch (e) {
        showToast('PDF ç”Ÿæˆå¤±æ•—');
    } finally {
        document.body.removeChild(container);
    }
});

// MD ä¸‹è¼‰
document.getElementById('downloadAiMd').addEventListener('click', () => downloadMd('aiResultText', 'AIæ™ºæ…§åˆ†æ'));
document.getElementById('downloadExpertMd').addEventListener('click', () => downloadMd('expertResultText', 'AIå°ˆå®¶å»ºè­°'));

function downloadMd(elementId, title) {
    const text = document.getElementById(elementId).textContent;
    if (!text) {
        showToast('æ²’æœ‰å¯ä¸‹è¼‰çš„å…§å®¹');
        return;
    }
    
    const stockCode = originalStockData[0]?.stockCode || 'STOCK';
    const stockName = originalStockData[0]?.stockName || '';
    const filename = `${stockCode}_${stockName}_${title}.md`;
    
    const blob = new Blob([text], { type: 'text/markdown;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    
    showToast('MD ä¸‹è¼‰å®Œæˆï¼');
}

// åœ–è¡¨ä¸‹è¼‰
document.querySelectorAll('[data-chart]').forEach(btn => {
    btn.addEventListener('click', async function() {
        const chartId = this.dataset.chart;
        const chart = charts[chartId];
        
        if (!chart) {
            showToast('è«‹å…ˆè¼‰å…¥è³‡æ–™');
            return;
        }
        
        showToast('æ­£åœ¨ä¸‹è¼‰åœ–è¡¨...');
        
        try {
            const { imgURI } = await chart.dataURI({ scale: 2 });
            const link = document.createElement('a');
            link.href = imgURI;
            link.download = `${chartId}_${new Date().toISOString().slice(0,10)}.png`;
            link.click();
            showToast('åœ–è¡¨ä¸‹è¼‰å®Œæˆï¼');
        } catch (e) {
            showToast('ä¸‹è¼‰å¤±æ•—');
        }
    });
});
</script>
</body>
</html>
